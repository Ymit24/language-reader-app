# AGENTS.md

This repository contains a cross-platform LingQ-style reader app built with
React Native (Expo), Expo Router, NativeWind, and Convex.

This file defines how contributors (humans and AI agents) should work in this
codebase: architecture, conventions, and “how we build” rules.

## Product goals (MVP)

The MVP must support:

- Email/password auth via Convex Auth (built-in tables; do not reimplement auth).
- Library: create lessons by pasting text (French/German first).
- Reader: tap words to open word details; set word status (unknown/learning/known).
- Highlight: already-known words should display as “quiet/grey”; unknown/learning
  should be marked.
- Vocab: global per user+language; carries across lessons.
- Review: minimal SRS queue and a review session loop.
- Works well on iPad and on web/desktop from one codebase.

Non-goals for MVP:

- Audio alignment, sentence timing.
- Phrase/n-gram LingQs.
- CJK (Japanese) segmentation and furigana.
- Offline-first local DB.

## Stack

- Expo (React Native)
- Expo Router for routing (web + native)
- NativeWind for styling
- Convex for backend DB + state sync
- Convex Auth for authentication

## App navigation & routes

Expo Router route groups:

- `app/(auth)/sign-in`
- `app/(app)/library`
- `app/(app)/library/new`
- `app/(app)/library/[lessonId]` (Reader)
- `app/(app)/review`
- `app/(app)/review/session`
- `app/(app)/settings`

Navigation chrome:
- Small screens/iPad: bottom tabs (Library/Review/Settings)
- Desktop web: sidebar + main content
Routes must remain identical across platforms.

Word details UI:
- Do not model as routes.
- Use local state (modal/bottom sheet on small; panel on desktop later).

## Backend data model (Convex)

Auth tables are generated by Convex Auth; do not create your own auth tables.

Application tables (owned by this app) include:
- `userLanguages`
- `lessons`
- `lessonTokens`
- `vocab`
- `vocabStats` (optional)
- `dictionaryCache`

Principles:
- Lessons store canonical `rawText`.
- Tokens are per-lesson occurrences (order + spacing/punct preserved).
- Vocab is global per user+language.
- Tokens map to vocab by `normalized` (string key), not foreign keys.
- Lemmatization is not required at import time (MVP); support incremental
  normalization later.

## Tokenization (French/German MVP)

During import:
- Tokenize into a sequence that preserves original text:
  - word tokens (`isWord=true`)
  - whitespace/punctuation tokens (`isWord=false`)
- For word tokens:
  - set `surface` to the original word
  - set `normalized` to a conservative normalization:
    - lowercase
    - strip surrounding punctuation
    - keep internal apostrophes/hyphens (`aujourd’hui`, `d'accord`, `E-Mail`)
- Do not attempt to solve separable verbs at import time.
- Do not lemmatize at import time (MVP).

Interaction:
- Reader coloring uses vocab map lookup by `token.normalized`.
- On tap, dictionary lookup may later upgrade `normalized` to lemma (v2).

## Dictionary strategy

MVP:
- Do not import full Wiktionary into Convex.
- Use a separate dictionary service (self-host VM) or third-party dictionary API.
- Convex stores a `dictionaryCache` so each lookup is fetched once per term.

Never:
- Depend on iOS/macOS system dictionaries for lemma extraction (not portable).

## Coding conventions

### TypeScript
- Use TypeScript everywhere (app + convex functions).
- Prefer explicit types for public component props and Convex function inputs.
- Avoid `any` except for raw cached dictionary payloads.

### Formatting
- Use Prettier with print width 80.
- Keep functions small; prefer pure helpers for tokenization/normalization.

### React Native / NativeWind
- Use `View` and `Text` appropriately (no raw strings outside `<Text>`).
- Use NativeWind `className` for layout/spacing/colors.
- Prefer restrained UI: borders over shadows, `rounded-md`, neutral palette.

### State & data fetching
- Screens own data fetching.
- Components should be mostly presentational; pass in data + callbacks.
- Avoid N+1 backend calls:
  - Reader should fetch tokens once and vocab map once per language.

## File organization

Suggested structure:

- `app/` Expo Router routes
- `src/components/` reusable UI components (Button, Card, Token, etc.)
- `src/features/reader/` reader-specific logic/components
- `src/features/review/` review logic/components
- `src/lib/` utilities (normalization, tokenization helpers)
- `convex/` schema + queries/mutations/actions

Keep tokenization helpers in `src/lib/tokenize/` and ensure they are deterministic.

## Convex function rules

- Use indexes; avoid full scans.
- Enforce uniqueness in code for:
  - vocab `(userId, language, term)`
  - dictionaryCache `(language, keyTerm)`
- Store `userId` as Convex Auth `identity.subject` unless the project chooses
  to reference auth user doc IDs explicitly (if changed, update schema + code).

## Security & privacy

- Every mutation must validate the user owns the resource:
  - `lesson.userId === currentUserId`
  - `token.userId === currentUserId`
  - `vocab.userId === currentUserId`
- Never log raw passwords or secrets.
- Dictionary service should not be directly callable by clients; call from Convex
  actions to centralize caching/rate-limiting.

## Performance goals

- Reader should handle ~10–30k characters smoothly on iPad.
- Avoid rendering each token as a heavy component when possible:
  - group by paragraphs if needed
  - memoize token components
- Keep reader state updates localized (changing one word status should not
  rerender the entire list unnecessarily).

## Testing checklist (manual MVP)

- Create lesson via paste.
- Open reader: tokens render with correct spacing/punct.
- Tap word: word details opens, status changes persist.
- Known words are quiet/grey across lessons.
- Review session runs and updates due dates/status.
- Works on:
  - iPad (touch + bottom tabs)
  - desktop web (sidebar layout + URLs)

## AI agent instructions

When generating code:
- Prefer minimal, shippable implementations over elaborate frameworks.
- Do not introduce new dependencies unless clearly justified.
- Keep the UI restrained and “product-like” (avoid neon colors, excessive
  rounding, heavy shadows).
- Ensure all new Convex functions validate ownership and use indexes.
- Provide changes as complete files or diffs; do not leave placeholders that
  break build/run.

If you need to make architectural changes (schema, routing, auth integration),
document the decision in this file and update related README/setup docs.
